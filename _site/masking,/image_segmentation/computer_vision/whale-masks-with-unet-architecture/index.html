<!DOCTYPE html>
<html lang="en">
<head><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link href="https://fonts.googleapis.com/css?family=Merriweather:300|Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="/assets/css/style.css">
<title>Whale Masks with Unet Architecture</title>
<meta name="og:title" content="Philipp Schwarz"/>
<meta name="og:description" content="Machine Learning Engineer & Data Scientist  with strong statistical  modeling and programming skills. I prefer working in a high-performance environment and in an interdisciplinary team. Reach out to me if you got a project that is unprecedented, and you need a pragmatic guy that delivers."/>
<meta property="og:image" content="/assets/portfolio.png"/>
<meta property="og:url" content="/"/></head>
<body>
	<main class="container">
		<section class="about">
			<a href="/"><img src="/assets/portfolio.png" alt="Philipp Schwarz"></a>
			<h2><a href="/" style="text-decoration: none">Philipp Schwarz</a></h2>
			<p class="tagline">Data Scientist</p>
			<ul class="social"><a href="https://github.com/philippschw"><li><i class="icon-github-circled"></i></li></a><a href="https://www.linkedin.com/in/philippschw"><li><i class="icon-linkedin-squared"></i></li></a><a href="https://twitter.com/philippschw"><li><i class="icon-twitter-squared"></i></li></a></ul>
			<p>&copy; 2020</p>
		</section>
		<section class="content">
			<div class="post-container">
  <a class="post-link" href="/masking,/image_segmentation/computer_vision/whale-masks-with-unet-architecture/">
    <h2 class="post-title">Whale Masks with Unet Architecture</h2>
  </a>
  <div class="post-meta">
    <ul class="post-categories"><li>masking,</li><li>image_segmentation</li><li>computer_vision</li></ul>
    <div class="post-date"><i class="icon-calendar"></i>May 28, 2016</div>
  </div>
  <div class="post">
    <p>The goal of this notebook is to show how to generate very good masks for the fluke of sperm whale based on only 450 annotated humpback flukes.</p>

<h2 id="what-are-masks">What are masks?</h2>

<p><a href="https://storage.googleapis.com/kaggle-forum-message-attachments/459392/11072/masks.zip">Data source</a></p>

<p>Packages used:</p>
<ul>
  <li>tensorflow, segmentation_models, albumentations</li>
</ul>

<p>This kernel shows how to generate very good masks for the fluke of the whale based on only 450 annotated fluke masks.
For this image segmentation task, I will describe the model architecture - U-NET and the data augmentation I used to mitigate overfitting.
The 450 fluke masks were provided by  Dene originally for the <a href="https://www.kaggle.com/c/whale-categorization-playground">Humpback Whale Identification Challenge on Kaggle</a> and can be downloaded <a href="https://storage.googleapis.com/kaggle-forum-message-attachments/459392/11072/masks.zip">here</a>. 
Segmenting the fluke and adding it as information in a fourth channel, significantly improved our score on the whale identification challenge. By adding it as a seperate channel the metric learning model can learn to recognize the fluke based on the characteristic contours of the fluke without loosing other potentially valuable information such as the background information of the sea.</p>

<p>I use pretrained keras models from this great repo <a href="https://github.com/qubvel/segmentation_models">segmentation_models</a> and sophisticated image augmentation using the python package <a href="https://github.com/albumentations-team/albumentations">albumentations</a>.</p>

<p>Fundamentally, the task is single class segmentation. Interestingly, only 450 fluke masks are enough to generalize to the whole train and test set of the kaggle channel and even to the GDSC dataset that has different image properties.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>

<span class="n">seed</span> <span class="o">=</span> <span class="mi">66</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">shutil</span>  <span class="kn">import</span> <span class="n">copyfile</span><span class="p">,</span> <span class="n">rmtree</span> 
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">ImageDataGenerator</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Dropout</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">SpatialDropout2D</span><span class="p">,</span> <span class="n">Input</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">applications</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing</span> <span class="kn">import</span> <span class="n">image</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing.image</span> <span class="kn">import</span> <span class="n">load_img</span>

<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">CSVLogger</span><span class="p">,</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">LearningRateScheduler</span><span class="p">,</span> <span class="n">EarlyStopping</span><span class="p">,</span> <span class="n">ReduceLROnPlateau</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">Adam</span><span class="p">,</span> <span class="n">SGD</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.losses</span> <span class="kn">import</span> <span class="n">binary_crossentropy</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span> <span class="k">as</span> <span class="n">K</span>

<span class="kn">import</span> <span class="nn">tensorflow.keras</span> <span class="k">as</span> <span class="n">keras</span>
<span class="kn">import</span> <span class="nn">segmentation_models</span> <span class="k">as</span> <span class="n">sm</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span><span class="p">,</span> <span class="n">tqdm</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tf</span><span class="o">.</span><span class="n">__version__</span>
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'2.1.0'
</code></pre></div></div>

<h2 id="key-points">Key points</h2>

<p>One of the key pillars for the creating good masks was to resize the image to an rectangular shape and do not make it quadratic.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DIMENSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">384</span><span class="p">,</span> <span class="mi">192</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TRAIN_PATH</span> <span class="o">=</span> <span class="s">'../input/train/'</span>
<span class="n">TEST_PATH</span> <span class="o">=</span> <span class="s">'../input/test/'</span>
<span class="n">MASK_PATH</span> <span class="o">=</span> <span class="s">'../input/masks/'</span>
<span class="n">WC_PATH</span> <span class="o">=</span> <span class="s">'../WC_input/data/'</span>
</code></pre></div></div>

<p>Lets begin by parsing the the 450  intial masks</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mask_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">MASK_PATH</span><span class="p">)</span>
<span class="c"># mask_files = [m for m in mask_files if 'mask' in m]</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">M</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">mask_file</span> <span class="ow">in</span> <span class="n">mask_files</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">TRAIN_PATH</span> <span class="o">+</span> <span class="n">mask_file</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">MASK_PATH</span> <span class="o">+</span> <span class="n">mask_file</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">mask</span><span class="o">&gt;</span><span class="mi">108</span><span class="p">]</span><span class="o">=</span> <span class="mi">255</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">mask</span><span class="o">&lt;=</span><span class="mi">108</span><span class="p">]</span><span class="o">=</span> <span class="mi">0</span>
    <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">M</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>

</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">img_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">WC_PATH</span><span class="p">)</span>

<span class="n">WC</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="n">img_files</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">WC_PATH</span> <span class="o">+</span> <span class="n">img_file</span><span class="p">)</span>
    <span class="n">WC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">WC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">WC</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="define-data-augmentation-transformations">Define Data augmentation transformations</h4>

<p>For data augmentation I use albumentations a libary that has a very simple, flexible APWe that allows the library to be plugged in any computer vision pipeline. The library provides almost any thinkable transformation and was written by Kaggle Masters</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">albumentations</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HorizontalFlip</span><span class="p">,</span> <span class="n">VerticalFlip</span><span class="p">,</span> <span class="n">IAAPerspective</span><span class="p">,</span> <span class="n">ShiftScaleRotate</span><span class="p">,</span> <span class="n">CLAHE</span><span class="p">,</span> <span class="n">RandomRotate90</span><span class="p">,</span>
    <span class="n">Transpose</span><span class="p">,</span> <span class="n">ShiftScaleRotate</span><span class="p">,</span> <span class="n">Blur</span><span class="p">,</span> <span class="n">OpticalDistortion</span><span class="p">,</span> <span class="n">GridDistortion</span><span class="p">,</span> <span class="n">HueSaturationValue</span><span class="p">,</span>
    <span class="n">IAAAdditiveGaussianNoise</span><span class="p">,</span> <span class="n">GaussNoise</span><span class="p">,</span> <span class="n">MotionBlur</span><span class="p">,</span> <span class="n">MedianBlur</span><span class="p">,</span> <span class="n">IAAPiecewiseAffine</span><span class="p">,</span>
    <span class="n">IAASharpen</span><span class="p">,</span> <span class="n">IAAEmboss</span><span class="p">,</span> <span class="n">RandomContrast</span><span class="p">,</span> <span class="n">RandomBrightness</span><span class="p">,</span> <span class="n">Flip</span><span class="p">,</span> <span class="n">OneOf</span><span class="p">,</span> <span class="n">Compose</span><span class="p">,</span> <span class="n">RandomGamma</span><span class="p">,</span> <span class="n">Rotate</span><span class="p">,</span><span class="n">IAAAffine</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">aug_null</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([])</span>
<span class="n">aug</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span> 
    <span class="n">Blur</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">blur_limit</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">IAAAffine</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">shear</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">HorizontalFlip</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>              
    <span class="n">Rotate</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
    <span class="n">RandomContrast</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
    <span class="n">RandomBrightness</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
<span class="p">])</span>

</code></pre></div></div>

<h4 id="define-data-loader">Define Data loader</h4>

<p>Besides the data loading procedure, here I defined the backbone of the unet model, I use <strong>seresnet34</strong>. In contrast to conventional resnet34, seresnet34 uses an additional trick called <strong>Squeeze-and-Excitation</strong> which often helps the model generalize extremely well. The (SE) block adaptively recalibrates
channel-wise feature responses by explicitly modelling interdependencies between channels. For more information take a look a the original <a href="https://arxiv.org/pdf/1709.01507.pdf">paper</a></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_name</span> <span class="o">=</span> <span class="s">'seresnet34'</span>
<span class="n">BACKBONE</span> <span class="o">=</span> <span class="n">model_name</span>
<span class="n">preprocess_input</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_preprocessing</span><span class="p">(</span><span class="n">BACKBONE</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DataGenerator</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
    <span class="s">'Generates data for Keras'</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                 <span class="n">dim</span><span class="o">=</span><span class="n">DIMENSION</span><span class="p">,</span>  <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                 <span class="n">preprocess_input</span><span class="o">=</span><span class="n">preprocess_input</span><span class="p">,</span> 
                 <span class="n">aug</span><span class="o">=</span><span class="n">aug_null</span><span class="p">,</span> <span class="n">min_mask</span><span class="o">=</span><span class="mi">2</span> <span class="p">):</span>
        <span class="s">'Initialization'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">M</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_input</span> <span class="o">=</span> <span class="n">preprocess_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aug</span> <span class="o">=</span> <span class="n">aug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'Denotes the number of batches per epoch'</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="s">'Generate one batch of data'</span>
        <span class="c"># Generate indexes of the batch</span>
        
        <span class="n">end_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">))</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">index</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>


        <span class="c"># Generate data</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_generation</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'Updates indexes after each epoch'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__data_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indexes</span><span class="p">):</span>
        <span class="s">'Generates data containing batch_size samples'</span> <span class="c"># X : (n_samples, *dim, n_channels)</span>
        
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>
        
        <span class="c"># Initialization</span>
        <span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s">'float32'</span><span class="p">)</span>
        <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s">'float32'</span><span class="p">)</span>

        <span class="c"># Generate data</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indexes</span><span class="p">):</span>
            <span class="c"># Store sample</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
            
            <span class="c"># Store class</span>
            <span class="n">augmented</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aug</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">aug_img</span> <span class="o">=</span> <span class="n">augmented</span><span class="p">[</span><span class="s">'image'</span><span class="p">]</span>
            <span class="n">aug_mask</span> <span class="o">=</span> <span class="n">augmented</span><span class="p">[</span><span class="s">'mask'</span><span class="p">]</span>
            <span class="n">aug_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">aug_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">aug_mask</span> <span class="o">=</span> <span class="n">aug_mask</span><span class="o">/</span><span class="mi">255</span>
            
            <span class="k">assert</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">aug_mask</span><span class="p">)</span><span class="o">&lt;=</span> <span class="mf">1.0</span> <span class="ow">and</span>  <span class="n">np</span><span class="o">.</span><span class="nb">min</span><span class="p">(</span><span class="n">aug_mask</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">aug_mask</span><span class="p">[</span><span class="n">aug_mask</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">aug_mask</span><span class="p">[</span><span class="n">aug_mask</span><span class="o">&lt;</span><span class="mf">0.5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="n">YY</span><span class="p">[</span><span class="n">i</span><span class="p">,]</span> <span class="o">=</span> <span class="n">aug_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
            <span class="n">XX</span><span class="p">[</span><span class="n">i</span><span class="p">,]</span> <span class="o">=</span> <span class="n">aug_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
    
       
        <span class="n">XX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_input</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">XX</span><span class="p">,</span> <span class="n">YY</span>
</code></pre></div></div>

<p>I define the default preprocessing for resnet architectures and create train and validation generators (<code class="highlighter-rouge">keras.utils.Sequence</code>). Note that the data augmentation is only applied on the training generator.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">training_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">X</span><span class="p">[:</span><span class="mi">450</span><span class="p">],</span> <span class="n">M</span><span class="p">[:</span><span class="mi">450</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="n">dim</span><span class="o">=</span><span class="n">DIMENSION</span><span class="p">,</span> <span class="n">aug</span><span class="o">=</span><span class="n">aug</span><span class="p">,</span> 
                                   <span class="n">preprocess_input</span><span class="o">=</span><span class="n">preprocess_input</span><span class="p">)</span>
<span class="n">valid_genarator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">450</span><span class="p">:],</span> <span class="n">M</span><span class="p">[</span><span class="mi">450</span><span class="p">:],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">DIMENSION</span><span class="p">,</span> <span class="n">aug</span><span class="o">=</span><span class="n">aug_null</span><span class="p">,</span> 
                                <span class="n">preprocess_input</span><span class="o">=</span><span class="n">preprocess_input</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="test-data-load">Test Data load</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span> <span class="n">training_generator</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="nb">max</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(255.0,
 (16, 192, 384, 3),
 (16, 192, 384, 1),
 1.0,
 array([0., 1.], dtype=float32))
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="images/whale-masks_19_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="images/whale-masks_20_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">segmentation_models</span> <span class="kn">import</span> <span class="n">Unet</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Unet</span><span class="p">(</span><span class="n">backbone_name</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">encoder_weights</span><span class="o">=</span><span class="s">'imagenet'</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="u-net-architecture">U-Net Architecture</h3>
<p>The U-NET architecture consists of two paths: encoder and decoder.</p>

<p>The encoder extracts features which contain information about what is in an image using convolutional and pooling layers.</p>

<p>Whilst encoding the size of the feature map gets reduced. The decoder is then used to recover the feature map size for the segmentation image, for which it uses Up-convolution layers.</p>

<p>Because the decoding process loses some of the higher level features the encoder learned, the U-NET has skip connections. That means that the outputs of the encoding layers are passed directly to the decoding layers so that all the important pieces of information can be preserved.</p>

<p>For more information check out the original <a href="https://arxiv.org/pdf/1505.04597.pdf">paper</a>.</p>

<p><img src="images/u-net-architecture.png" alt="title" /></p>

<h4 id="loss-for-image-segmentation-dice-coefficient">Loss for image segmentation: Dice Coefficient</h4>
<p>Simply put, the Dice Coefficient is 2 * the Area of Overlap divided by the total number of pixels in both images.</p>

<p>![title]((images/dice_coeff.png)</p>

<hr />
<p><img src="images/dice_coeff2.png" alt="title" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">dice_coeff_L</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">smooth</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">y_pred_sig</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>

    <span class="n">y_true_f</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">y_pred_f</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y_pred_sig</span><span class="p">)</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_true_f</span> <span class="o">*</span> <span class="n">y_pred_f</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">intersection</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_true_f</span><span class="p">)</span> <span class="o">+</span> <span class="n">K</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_pred_f</span><span class="p">)</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">score</span>

<span class="k">def</span> <span class="nf">dice_coeff</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
<span class="c">#     ipdb.set_trace()</span>
    <span class="n">smooth</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="n">y_true_f</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y_true</span><span class="p">)</span>
    <span class="n">y_pred_f</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="n">K</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_true_f</span> <span class="o">*</span> <span class="n">y_pred_f</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">intersection</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_true_f</span><span class="p">)</span> <span class="o">+</span> <span class="n">K</span><span class="o">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">y_pred_f</span><span class="p">)</span> <span class="o">+</span> <span class="n">smooth</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">score</span>


<span class="k">def</span> <span class="nf">dice_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">dice_coeff</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="k">def</span> <span class="nf">bce_dice_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">binary_crossentropy</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">+</span> <span class="n">dice_loss</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div></div>

<p>Let’s train the model to see what I can get.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">training_generator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">X</span><span class="p">[:</span><span class="mi">400</span><span class="p">],</span> <span class="n">M</span><span class="p">[:</span><span class="mi">400</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>  <span class="n">dim</span><span class="o">=</span><span class="n">DIMENSION</span><span class="p">,</span> <span class="n">aug</span><span class="o">=</span><span class="n">aug</span><span class="p">,</span> 
                                   <span class="n">preprocess_input</span><span class="o">=</span><span class="n">preprocess_input</span><span class="p">)</span>
<span class="n">valid_genarator</span> <span class="o">=</span> <span class="n">DataGenerator</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">400</span><span class="p">:],</span> <span class="n">M</span><span class="p">[</span><span class="mi">400</span><span class="p">:],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">DIMENSION</span><span class="p">,</span> <span class="n">aug</span><span class="o">=</span><span class="n">aug_null</span><span class="p">,</span> 
                                <span class="n">preprocess_input</span><span class="o">=</span><span class="n">preprocess_input</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
          <span class="n">loss</span><span class="o">=</span><span class="n">bce_dice_loss</span><span class="p">,</span>
          <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">dice_coeff</span><span class="p">])</span>

<span class="n">epochs</span> <span class="o">=</span> <span class="mi">40</span>

<span class="c"># Load trained model if exists, otherwise train model</span>
<span class="n">model_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s">'fpnseresnet34_384-192_34-0.061-0.976.hdf5'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">model_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
    <span class="n">model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">model_file</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">patience</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s">'val_dice_coeff'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'max'</span><span class="p">)</span>
    <span class="n">model_checkpoint</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="s">"fpnseresnet34_384-192_{epoch:02d}-{val_loss:.3f}-{val_dice_coeff:.3f}.hdf5"</span><span class="p">,</span> 
                                       <span class="n">save_best_only</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                       <span class="n">save_weights_only</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                       <span class="n">monitor</span><span class="o">=</span><span class="s">'val_dice_coeff'</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'max'</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">reduce_lr</span> <span class="o">=</span> <span class="n">ReduceLROnPlateau</span><span class="p">(</span><span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_lr</span><span class="o">=</span><span class="mf">0.000001</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">monitor</span><span class="o">=</span><span class="s">'val_dice_coeff'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'max'</span><span class="p">)</span>


    <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span> <span class="n">training_generator</span><span class="p">,</span>
                                 <span class="n">validation_data</span><span class="o">=</span><span class="n">valid_genarator</span><span class="p">,</span>
                                 <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
                                 <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span> <span class="n">reduce_lr</span><span class="p">,</span> <span class="n">early_stopping</span><span class="p">,</span> <span class="n">model_checkpoint</span><span class="p">],</span> 
                                 <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>Lets now define the <code class="highlighter-rouge">TestDataGenerator</code> class that also extends <code class="highlighter-rouge">keras.utils.Sequence</code> but ignores masks. This generator will be used for inference.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">aug_null</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([])</span>


<span class="k">class</span> <span class="nc">TestDataGenerator</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
    <span class="s">'Generates data for Keras'</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                 <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">299</span><span class="p">,</span><span class="mi">299</span><span class="p">),</span>  <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                 <span class="n">preprocess_input</span><span class="o">=</span><span class="n">preprocess_input</span><span class="p">,</span> 
                 <span class="n">aug</span><span class="o">=</span><span class="n">aug_null</span><span class="p">,</span> <span class="n">min_mask</span><span class="o">=</span><span class="mi">2</span> <span class="p">):</span>
        <span class="s">'Initialization'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_input</span> <span class="o">=</span> <span class="n">preprocess_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aug</span> <span class="o">=</span> <span class="n">aug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">set_aug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aug</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aug</span> <span class="o">=</span> <span class="n">aug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_epoch_end</span><span class="p">()</span>
      
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'Denotes the number of batches per epoch'</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="s">'Generate one batch of data'</span>
        <span class="c"># Generate indexes of the batch</span>
        
        <span class="n">end_index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">))</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="n">index</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>

        <span class="c"># Find list of IDs</span>

        <span class="c"># Generate data</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data_generation</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xx</span>

    <span class="k">def</span> <span class="nf">on_epoch_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">'Updates indexes after each epoch'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__data_generation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indexes</span><span class="p">):</span>
        <span class="s">'Generates data containing batch_size samples'</span> <span class="c"># X : (n_samples, *dim, n_channels)</span>
        
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>
        
        <span class="c"># Initialization</span>
        <span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s">'float32'</span><span class="p">)</span>

        <span class="c"># Generate data</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ID</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indexes</span><span class="p">):</span>
            <span class="c"># Store sample</span>
            <span class="n">img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>
            
            
            <span class="c"># Store class</span>
            <span class="n">augmented</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aug</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
            <span class="n">aug_img</span> <span class="o">=</span> <span class="n">augmented</span><span class="p">[</span><span class="s">'image'</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">aug_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">aug_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">aug_img</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">INTER_CUBIC</span><span class="p">)</span>
            <span class="n">XX</span><span class="p">[</span><span class="n">i</span><span class="p">,]</span> <span class="o">=</span> <span class="n">aug_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
    
       
        <span class="n">XX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_input</span><span class="p">(</span><span class="n">XX</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">XX</span>
</code></pre></div></div>

<h3 id="make-predicitions-on-gdsc-dataset">Make Predicitions on GDSC dataset</h3>

<p>I use Test-time augmentation (TTA) which applies also data augmentation to the test dataset and by averaging predictions, I achieve a little bit more robust masks.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">null_aug</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([])</span>
<span class="n">test_generator</span> <span class="o">=</span> <span class="n">TestDataGenerator</span><span class="p">(</span><span class="n">WC</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">aug</span><span class="o">=</span><span class="n">null_aug</span><span class="p">,</span> <span class="n">preprocess_input</span><span class="o">=</span><span class="n">preprocess_input</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">DIMENSION</span><span class="p">,</span> 
                               <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">preds</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_generator</span><span class="p">(</span><span class="n">test_generator</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">flip_aug</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span><span class="n">HorizontalFlip</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span> <span class="p">])</span>
<span class="n">test_generator</span> <span class="o">=</span> <span class="n">TestDataGenerator</span><span class="p">(</span><span class="n">WC</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">aug</span><span class="o">=</span><span class="n">flip_aug</span><span class="p">,</span> <span class="n">preprocess_input</span><span class="o">=</span><span class="n">preprocess_input</span><span class="p">,</span>  <span class="n">dim</span><span class="o">=</span><span class="n">DIMENSION</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">preds_hflip</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_generator</span><span class="p">(</span><span class="n">test_generator</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">blur_aug</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span><span class="n">Blur</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)])</span>
<span class="n">test_generator</span> <span class="o">=</span> <span class="n">TestDataGenerator</span><span class="p">(</span><span class="n">WC</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">aug</span><span class="o">=</span><span class="n">blur_aug</span><span class="p">,</span> <span class="n">preprocess_input</span><span class="o">=</span><span class="n">preprocess_input</span><span class="p">,</span>  <span class="n">dim</span><span class="o">=</span><span class="n">DIMENSION</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">preds_blur</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_generator</span><span class="p">(</span><span class="n">test_generator</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARNING:tensorflow:From &lt;ipython-input-35-756d55b3dd04&gt;:4: Model.predict_generator (from tensorflow.python.keras.engine.training) is deprecated and will be removed in a future version.
Instructions for updating:
Please use Model.predict, which supports generators.
334/334 [==============================] - 141s 423ms/step
334/334 [==============================] - 127s 379ms/step
334/334 [==============================] - 125s 373ms/step
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TARGET_VAL</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">preds</span><span class="p">)):</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">preds_hflip</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">preds_blur</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">3</span>
    <span class="n">TARGET_VAL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>

<span class="n">TARGET_VAL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">TARGET_VAL</span><span class="p">)</span>  
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">label</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">WC</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">WC</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">DIMENSION</span><span class="p">))</span>

<span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">TARGET_VAL</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,:,</span> <span class="mi">0</span><span class="p">])</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">TARGET_VAL</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>


<span class="n">ax1</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">'original'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">'resized'</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">'mask'</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s">'mask threshold .5'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/images/whale-masks_32_0.png" alt="png" /></p>

<h3 id="make-predicitions-on-kaggle-dataset">Make Predicitions on Kaggle Dataset</h3>

<p>When we want to use the whale flukes provided by Kaggle for pretraining, we should also create masks on this dataset.</p>

<p>The nice side effect from segmenting the whale flukes is that I can get tight bounding boxes as well. In the figure bellow I keep a tight bounding box and only pixels that correspond to the mask. There are several ways to move from here:</p>
<h4 id="draw-masked-flukes-on-white-background">Draw masked flukes on white background</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SIZE</span> <span class="o">=</span> <span class="mi">384</span>
<span class="n">f</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
<span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">36</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span>  <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">WC</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">DIMENSION</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">TARGET_VAL</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.25</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">axarr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span> <span class="n">i</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
        <span class="n">axarr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span> <span class="n">i</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="n">back</span> <span class="o">=</span> <span class="p">((</span><span class="n">TARGET_VAL</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">0.25</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'uint8'</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span> <span class="o">+</span> <span class="n">back</span><span class="o">*</span><span class="mi">255</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">contours</span><span class="p">,</span><span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="c"># Cycle through contours and add area to array</span>
    <span class="n">areas</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
        <span class="n">areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>

    <span class="c"># Sort array of areas by size</span>
    <span class="n">sorted_areas</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">areas</span><span class="p">,</span> <span class="n">contours</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_areas</span><span class="p">))</span> 
    
    <span class="n">cnt</span> <span class="o">=</span> <span class="n">sorted_areas</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">w</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">+</span> <span class="n">h</span>
    
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_areas</span><span class="p">)):</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">sorted_areas</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tx1</span><span class="p">,</span><span class="n">ty1</span><span class="p">,</span><span class="n">tw</span><span class="p">,</span><span class="n">th</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
        <span class="n">tx2</span> <span class="o">=</span> <span class="n">tx1</span> <span class="o">+</span> <span class="n">tw</span>
        <span class="n">ty2</span> <span class="o">=</span> <span class="n">ty1</span> <span class="o">+</span> <span class="n">th</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">tx1</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">ty1</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">tx2</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">ty2</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">x1</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y1</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">x2</span><span class="o">-</span><span class="n">x1</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">y2</span><span class="o">-</span><span class="n">y1</span>


    <span class="n">img_cropped</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
    <span class="n">axarr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span> <span class="n">i</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_cropped</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
    <span class="n">axarr</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span> <span class="n">i</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="images/whale-masks_36_0.png" alt="png" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

  </div></div>

		</section>
	</main></body>
</html>
